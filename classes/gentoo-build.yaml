inherit: [in-docker]

# Note: this script defines two functions that come on stage when portages
# snapshot is located on compressed squashfs system. Internally, invokes FUSE
# mouting procedures for squashfs:
# mount:
#   $ squashfuse /tmp/gentoo-20180318.xz.sqfs $(pwd)/mountpoint
# umount:
#   $ fusermount -u $(pwd)/mountpoint

depends:
    - gentoo-portages

environment:
    GENTOO_BASE_IMAGE: "gentoo/stage3-amd64"

buildVars: 
    - PORTAGES_SNAPSHOT
    - PORTAGES_SNAPSHOT_FILE

buildTools: [docker]
buildScript: |
    # Note: these few are only used when portages are on the squashfs:
    mount_sqfs_portages() {
        mkdir -p portages.mount
        squashfuse "$PORTAGES_SNAPSHOT" portages.mount
    }
    umount_sqfs_portages() {
        fusermount -u portages.mount
    }
    #PORTAGES_SNAPSHOT=(${BOB_DEP_PATHS[gentoo-portages]}/gentoo-*)
    #PORTAGES_SNAPSHOT_FILE=$(basename "$PORTAGES_SNAPSHOT")
    #if [[ "$PORTAGES_SNAPSHOT_FILE" == *.sqfs ]] ; then
    #    mount_sqfs_portages
    #    trap umount_sqfs_portages EXIT
    #    ${DOCKER_COMMAND} run --name #... binfarm-gentoo-base:${GENTOO_STAGE3_TAG}
    #    umount_sqfs_portages
    #else
    #    (>&2 echo "Error: unable to mount portages in \"$PORTAGES_SNAPSHOT_FILE\".")
    #    exit 1
    #fi
